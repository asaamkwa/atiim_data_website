<%- include('../partials/userheader') %>




<form method="post" action="/user/manuel/payment">
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-12 col-sm-10 col-md-8 col-lg-5">

        <div class="card shadow-lg">
          <div class="card-body p-4 p-md-5">

            <h4 class="card-title mb-4 text-center fw-bold text-primary">
              Buy Data Bundle
            </h4>

            <!-- Network Select -->
            <div class="mb-3">
              <label class="form-label fw-semibold">Select Network</label>
              <select class="form-select form-select-lg" id="networkSelect" name="network" required>
                <option value="" disabled selected>Select network</option>
                <option value="MTN">MTN</option>
                <option value="AIRTELTIGO">AirtelTigo</option>
                <option value="TELECEL">Telecel</option>
              </select>
            </div>

            <!-- Beneficiary Number -->
            <div class="mb-3">
              <label class="form-label fw-semibold">Beneficiary Number</label>
              <input type="tel"
                     name="payerNumber"
                     class="form-control form-control-lg"
                     placeholder="0550000000"
                     required>
            </div>

            <!-- Bundle Size -->
            <div class="mb-3">
              <label class="form-label fw-semibold">Select Bundle Size</label>
              <select class="form-select form-select-lg" id="bundleSelect" name="bundleId" required>
                <option value="" disabled selected>Select bundle size</option>
              </select>
            </div>

            <!-- Bundle Price -->
            <div class="mb-3 text-center bundle-price">
              Bundle Price Selected: <span id="bundlePriceDisplay">GHS 0.00</span>
            </div>

            <!-- Charges Notice -->
            <div class="alert alert-light alert-custom small mb-3">
              Includes all applicable charges
            </div>

            <!-- Warning -->
            <div class="alert alert-warning small">
              ⚠️ There will be no refund for a wrong beneficiary number.
            </div>

            <!-- Pay Button -->
            <button type="submit" class="btn btn-primary btn-lg w-100">
              Pay with Wallet
            </button>

          </div>
        </div>

      </div>
    </div>
  </div>
</form>

<script>
const networkSelect = document.getElementById('networkSelect');
const bundleSelect = document.getElementById('bundleSelect');
const priceDisplay = document.getElementById('bundlePriceDisplay');

networkSelect.addEventListener('change', async () => {
  const network = networkSelect.value;

  // Clear previous options
  bundleSelect.innerHTML = '<option value="" disabled selected>Loading...</option>';
  priceDisplay.textContent = 'GHS 0.00';

  try {
    const res = await fetch(`/user/bundles/${network}`);
    const bundles = await res.json();

    // Populate dropdown
    bundleSelect.innerHTML = '<option value="" disabled selected>Select bundle size</option>';
    bundles.forEach(bundle => {
      const option = document.createElement('option');
      option.value = bundle._id; // Send bundle ID in form
      option.dataset.price = bundle.price; // Store price for display
      option.textContent = `${bundle.name} — GHS ${bundle.price.toFixed(2)}`;
      bundleSelect.appendChild(option);
    });
  } catch (err) {
    console.error(err);
    bundleSelect.innerHTML = '<option value="" disabled selected>Error loading bundles</option>';
  }
});

// Update price display when a bundle is selected
bundleSelect.addEventListener('change', () => {
  const selectedOption = bundleSelect.selectedOptions[0];
  const price = selectedOption.dataset.price || 0;
  priceDisplay.textContent = `GHS ${parseFloat(price).toFixed(2)}`;
});
</script>


<%- include('../partials/footer') %>
